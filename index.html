<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق المشتركين</title>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
            background-color: #f9f9f9;
            padding: 20px;
        }

        .container {
            width: 850px;
            margin: auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        input, button, select, textarea {
            margin: 10px 0;
            padding: 12px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }
    </style>
    <!-- Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLozqHT0vU9_E9nX5SMHeK80akAwYcP5w",
            authDomain: "resiller-a9868.firebaseapp.com",
            projectId: "resiller-a9868",
            storageBucket: "resiller-a9868.appspot.com",
            messagingSenderId: "984544326620",
            appId: "1:984544326620:web:87a481597de65a61bb5519"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    </script>
</head>
<body onload="loadData()">
    <div class="container">
        <h2>إدارة المشتركين والفواتير</h2>

        <label>إضافة مشترك جديد:</label>
        <input type="text" id="newClientName" placeholder="اسم المشترك">
        <button onclick="addClient()">إضافة مشترك</button>

        <label>اختر المشترك:</label>
        <select id="clientSelect" onchange="updateInvoices()"></select>
        <button onclick="deleteClient()">حذف مشترك</button>

        <label>سعر الاشتراك:</label>
        <input type="number" id="subscriptionPrice" placeholder="السعر">

        <label>ملاحظة:</label>
        <textarea id="invoiceNote"></textarea>

        <button onclick="addInvoice()">إضافة فاتورة</button>

        <h3>الفواتير:</h3>
        <div id="invoicesList"></div>

        <h3>الحساب الكلي:</h3>
        <div id="totalAccount">0</div>
    </div>

    <script>
        const dbFileName = 'data.json';

        // تحميل البيانات من ملف JSON
        async function loadData() {
            try {
                const response = await fetch(dbFileName);
                if (response.ok) {
                    const data = await response.json();
                    clientsDB = data.clients || [];
                    invoicesDB = data.invoices || [];
                    updateClientSelect();
                    updateInvoices();
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
            }
        }

        // حفظ البيانات في ملف JSON
        async function saveData() {
            const data = { clients: clientsDB, invoices: invoicesDB };
            try {
                await fetch(dbFileName, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                console.log('تم حفظ البيانات بنجاح.');
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
            }
        }

        let clientsDB = [];
        let invoicesDB = [];

        function addClient() {
            const newClientName = document.getElementById('newClientName').value.trim();
            if (newClientName && !clientsDB.includes(newClientName)) {
                clientsDB.push(newClientName);
                updateClientSelect();
                saveData();
                document.getElementById('newClientName').value = '';
            }
        }

        function deleteClient() {
            const clientName = document.getElementById('clientSelect').value;
            if (clientName) {
                clientsDB = clientsDB.filter(client => client !== clientName);
                invoicesDB = invoicesDB.filter(invoice => invoice.clientName !== clientName);
                updateClientSelect();
                updateInvoices();
                saveData();
            }
        }

        function updateClientSelect() {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '';
            clientsDB.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
        }

        function addInvoice() {
            const clientName = document.getElementById('clientSelect').value;
            const subscriptionPrice = parseFloat(document.getElementById('subscriptionPrice').value);
            const note = document.getElementById('invoiceNote').value.trim();
            const date = new Date().toLocaleString();

            if (clientName && subscriptionPrice) {
                const invoice = {
                    id: Date.now(),
                    clientName,
                    price: subscriptionPrice,
                    date,
                    status: 'unpaid',
                    note,
                    paymentDate: null,
                };
                invoicesDB.push(invoice);
                updateInvoices();
                saveData();
            } else {
                alert('يرجى اختيار المشترك وإدخال سعر الاشتراك');
            }
        }

        function updateInvoices() {
            const selectedClient = document.getElementById('clientSelect').value;
            const invoicesList = document.getElementById('invoicesList');
            invoicesList.innerHTML = '';
            invoicesDB.filter(invoice => invoice.clientName === selectedClient).forEach(invoice => {
                const div = document.createElement('div');
                div.className = 'invoice';
                div.innerHTML = `
                    <strong>المبلغ:</strong> ${invoice.price} |
                    <strong>التاريخ:</strong> ${invoice.date}<br>
                    <strong>ملاحظة:</strong> ${invoice.note}<br>
                    <strong>تاريخ الدفع:</strong> ${invoice.paymentDate || 'لم يتم الدفع بعد'}<br>
                    <button onclick="togglePayment(${invoice.id})">${invoice.status === 'paid' ? 'إلغاء الدفع' : 'دفع'}</button>
                    <button onclick="deleteInvoice(${invoice.id})">حذف</button>
                    <button onclick="editNote(${invoice.id})">تعديل الملاحظة</button>
                `;
                invoicesList.appendChild(div);
            });
            updateTotalAccount();
        }

        function togglePayment(id) {
            invoicesDB.forEach(invoice => {
                if (invoice.id === id) {
                    invoice.status = invoice.status === 'paid' ? 'unpaid' : 'paid';
                    invoice.paymentDate = invoice.status === 'paid' ? new Date().toLocaleString() : null;
                }
            });
            updateInvoices();
            saveData();
        }

        function deleteInvoice(id) {
            invoicesDB = invoicesDB.filter(invoice => invoice.id !== id);
            updateInvoices();
            saveData();
        }

        function editNote(id) {
            const newNote = prompt("أدخل الملاحظة الجديدة:");
            if (newNote !== null) {
                invoicesDB.forEach(invoice => {
                    if (invoice.id === id) {
                        invoice.note = newNote;
                    }
                });
                updateInvoices();
                saveData();
            }
        }

        function updateTotalAccount() {
            const selectedClient = document.getElementById('clientSelect').value;
            const total = invoicesDB
                .filter(invoice => invoice.clientName === selectedClient && invoice.status === 'unpaid')
                .reduce((sum, invoice) => sum + invoice.price, 0);
            document.getElementById('totalAccount').textContent = total;
        }
    </script>
</body>
</html>
