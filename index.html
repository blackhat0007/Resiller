<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق إدارة المشتركين</title>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
            background-color: #f9f9f9;
            padding: 20px;
        }

        .container {
            width: 850px;
            margin: auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        input, button, select, textarea {
            margin: 10px 0;
            padding: 12px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }
    </style>
    <!-- Firebase -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, set, push, get, child, update, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLozqHT0vU9_E9nX5SMHeK80akAwYcP5w",
            authDomain: "resiller-a9868.firebaseapp.com",
            databaseURL: "https://resiller-a9868-default-rtdb.firebaseio.com/",
            projectId: "resiller-a9868",
            storageBucket: "resiller-a9868.appspot.com",
            messagingSenderId: "984544326620",
            appId: "1:984544326620:web:87a481597de65a61bb5519"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Helper functions for Firebase operations
        const clientsRef = ref(db, 'clients');
        const invoicesRef = ref(db, 'invoices');

        async function loadClients() {
            const snapshot = await get(clientsRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                updateClientSelect(Object.keys(data));
            }
        }

        async function loadInvoices(clientName) {
            const snapshot = await get(invoicesRef);
            const invoicesList = document.getElementById('invoicesList');
            invoicesList.innerHTML = '';

            if (snapshot.exists()) {
                const data = snapshot.val();
                let total = 0;

                Object.keys(data).forEach(key => {
                    const invoice = data[key];
                    if (invoice.clientName === clientName) {
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <strong>المبلغ:</strong> ${invoice.price} |
                            <strong>التاريخ:</strong> ${invoice.date}<br>
                            <strong>ملاحظة:</strong> ${invoice.note}<br>
                            <strong>تاريخ الدفع:</strong> ${invoice.paymentDate || 'لم يتم الدفع بعد'}<br>
                            <button onclick="togglePayment('${key}')">${invoice.status === 'paid' ? 'إلغاء الدفع' : 'دفع'}</button>
                            <button onclick="deleteInvoice('${key}')">حذف</button>
                            <button onclick="editNotePrompt('${key}')">تعديل الملاحظة</button>
                        `;
                        invoicesList.appendChild(div);
                        if (invoice.status === 'unpaid') {
                            total += parseFloat(invoice.price);
                        }
                    }
                });

                document.getElementById('totalAccount').textContent = total;
            }
        }

        async function addClient() {
            const clientName = document.getElementById('newClientName').value.trim();
            if (clientName) {
                const newClientRef = push(clientsRef);
                await set(newClientRef, { name: clientName });
                document.getElementById('newClientName').value = '';
                loadClients();
            }
        }

        async function deleteClient() {
            const clientName = document.getElementById('clientSelect').value;
            if (clientName) {
                const clientSnapshot = await get(clientsRef);
                if (clientSnapshot.exists()) {
                    const data = clientSnapshot.val();
                    const clientKey = Object.keys(data).find(key => data[key].name === clientName);
                    if (clientKey) {
                        await remove(child(clientsRef, clientKey));
                        loadClients();
                    }
                }

                const invoiceSnapshot = await get(invoicesRef);
                if (invoiceSnapshot.exists()) {
                    const data = invoiceSnapshot.val();
                    Object.keys(data).forEach(async key => {
                        if (data[key].clientName === clientName) {
                            await remove(child(invoicesRef, key));
                        }
                    });
                }

                document.getElementById('invoicesList').innerHTML = '';
                document.getElementById('totalAccount').textContent = 0;
            }
        }

        async function addInvoice() {
            const clientName = document.getElementById('clientSelect').value;
            const price = parseFloat(document.getElementById('subscriptionPrice').value);
            const note = document.getElementById('invoiceNote').value.trim();

            if (clientName && price) {
                const newInvoiceRef = push(invoicesRef);
                const invoice = {
                    clientName,
                    price,
                    date: new Date().toLocaleString(),
                    status: 'unpaid',
                    note,
                    paymentDate: null
                };
                await set(newInvoiceRef, invoice);
                loadInvoices(clientName);
                document.getElementById('subscriptionPrice').value = '';
                document.getElementById('invoiceNote').value = '';
            } else {
                alert('يرجى إدخال البيانات المطلوبة.');
            }
        }

        async function togglePayment(invoiceId) {
            const invoiceRef = child(invoicesRef, invoiceId);
            const snapshot = await get(invoiceRef);
            if (snapshot.exists()) {
                const invoice = snapshot.val();
                invoice.status = invoice.status === 'paid' ? 'unpaid' : 'paid';
                invoice.paymentDate = invoice.status === 'paid' ? new Date().toLocaleString() : null;
                await update(invoiceRef, invoice);
                loadInvoices(document.getElementById('clientSelect').value);
            }
        }

        async function deleteInvoice(invoiceId) {
            const invoiceRef = child(invoicesRef, invoiceId);
            await remove(invoiceRef);
            loadInvoices(document.getElementById('clientSelect').value);
        }

        async function editNotePrompt(invoiceId) {
            const newNote = prompt("أدخل الملاحظة الجديدة:");
            if (newNote !== null) {
                const invoiceRef = child(invoicesRef, invoiceId);
                await update(invoiceRef, { note: newNote });
                loadInvoices(document.getElementById('clientSelect').value);
            }
        }

        function updateClientSelect(clients) {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
            if (clients.length > 0) {
                loadInvoices(clients[0]);
            }
        }

        // Load data on page load
        window.onload = loadClients;
    </script>
</head>
<body>
    <div class="container">
        <h2>إدارة المشتركين والفواتير</h2>

        <label>إضافة مشترك جديد:</label>
        <input type="text" id="newClientName" placeholder="اسم المشترك">
        <button onclick="addClient()">إضافة مشترك</button>

        <label>اختر المشترك:</label>
        <select id="clientSelect" onchange="loadInvoices(this.value)"></select>
        <button onclick="deleteClient()">حذف مشترك</button>

        <label>سعر الاشتراك:</label>
        <input type="number" id="subscriptionPrice" placeholder="السعر">

        <label>ملاحظة:</label>
        <textarea id="invoiceNote"></textarea>

        <button onclick="addInvoice()">إضافة فاتورة</button>

        <h3>الفواتير:</h3>
        <div id="invoicesList"></div>

        <h3>الحساب الكلي:</h3>
        <div id="totalAccount">0</div>
    </div>
</body>
</html>
